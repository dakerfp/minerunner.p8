pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

function mouse()
	x=stat(32)
	y=stat(33)
	b=stat(34)
	return x,y,b
end


-->8
row_width=16
s_0=32
s_unr=17
s_mine=4

rows={}
vel=0.02
dy=0

function create_blank_row()
	row={}
	for i=1,row_width do
		add(row,{s=s_unr,v=s_0})
	end
	return row
end

function create_row(bombs)
	bombs=bombs or 1
	row=create_blank_row()
	for b=1,bombs do
		bi=flr(rnd(row_width))+1
		row[bi]={s=s_unr,v=s_mine}
	end
	return row
end

function has_mine(x,y)
	if (x<1 or x>row_width) return 0
	if (y<1 or y>#rows) return 0
	return (rows[y][x].v==s_mine) and 1 or 0
end

function count_mines(x,y)
		return has_mine(x-1,y-1) +
			has_mine(x-1,y) +
			has_mine(x-1,y+1) +
			has_mine(x,y-1) +
			has_mine(x,y+1) +
			has_mine(x+1,y-1) +
			has_mine(x+1,y) +
			has_mine(x+1,y+1)
end

function update_row_count(y)
	for x=1,row_width do
		if rows[y][x].v != s_mine then
			rows[y][x].v=s_0+count_mines(x,y)
			if rows[y][x].s != s_unr then
				v=rows[y][x].v
				rows[y][x].s=v
				mset(x-1,y-1,v)
			end
		end
	end
end

function rotate_row(r)
	-- rotate
	nrows={} -- delete rows[1]
	for y=2,#rows do
		add(nrows,rows[y])
	end
	rows=nrows
	add(rows,r)
	-- update last two rows
	for y=#rows-5,#rows do
		update_row_count(y)
	end
	-- update map
	for y=1,#rows do
		row=rows[y]
		for x=1,#row do
			mset(x-1,y-1,row[x].s)
		end
	end
end

function reveal(x,y)
	if (x<1 or x>row_width) return s_unr
	if (y<1 or y>#rows) return s_unr
	if rows[y][x].s == s_unr then
		rows[y][x].s=rows[y][x].v
		if rows[y][x].v == s_0 then
			reveal(x-1,y-1)
			reveal(x-1,y)
			reveal(x-1,y+1)
			reveal(x,y-1)
			reveal(x,y+1)
			reveal(x+1,y-1)
			reveal(x+1,y)
			reveal(x+1,y+1)
		end
	end
	mset(x-1,y-1,rows[y][x].s)
	return rows[y][x].s
end

function _init()
	poke(0x5f2d, 1)
	_vel=0.02
	dy=0
	rows={}
	for y=1,10 do
		add(rows,create_blank_row())
	end
	for y=1,9 do
		add(rows,create_row(1))
	end
	for y=1,#rows do
		update_row_count(y)
	end
end

function map_to_grid(mx,my)
	x=flr((mx+1)/8)+1
	y=flr((my-dy)/8)+1
	x=mid(1,x,row_width)
	y=mid(1,y,#rows)
	return x,y
end

mx,my,mb=0,0,0
function _update()
	mx,my,mb=mouse()
	if (band(mb,1)==1) then
		x,y=map_to_grid(mx,my)
		reveal(x,y)
	end
	if (band(mb,4)==4) then
		dy-=0.5
	else
		dy-=vel
	end
	if dy < -8 then
		r=create_row(1)
		rotate_row(r)
		dy+=8
		return
	end
end

-->8

function _draw()
	cls()
	map(0,0,0,dy,16,#rows)
	print(dy)
	spr(1,mx-2,my)
	x,y=map_to_grid(mx,my)
	print(x,60,45,9)
	print(y,90,45,9)
end
__gfx__
00000000010000000000000000000000bbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000171000000000000000000000b5b55b530000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700177100000000000000000000bb5555bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000177710000000000000000000b55a85530000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000177771000000000000000000b558a55b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700177110000000000000000000bb5555b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011710000000000000000000b5b55b5b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000b3b3b3b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb33333333dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbb33333333b0bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb333333330bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbb33333333b0bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb333333330bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbb33333333b0bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb333333330bbbbbbd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b3b3b3b33b3b3b3b0000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00000000000000000000000000000000000000000000000000000000
bbbbbbb3bbeebbb3bbcccbb3bb111bb3bb8b8bb3bb999bb3bb222bb3bb444bb3bb000bb300000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbebbbbbbbbcbbbbbbb1bbbbb8b8bbbbb9bbbbbbb2bbbbbbbbb4bbbbb0b0bbb00000000000000000000000000000000000000000000000000000000
bbbbbbb3bbbebbb3bbcccbb3bbb11bb3bb888bb3bb999bb3bb222bb3bbbb4bb3bb000bb300000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbebbbbbbcbbbbbbbbb1bbbbbbb8bbbbbbb9bbbbb2b2bbbbbbb4bbbbb0b0bbb00000000000000000000000000000000000000000000000000000000
bbbbbbb3bbeeebb3bbcccbb3bb111bb3bbbb8bb3bb999bb3bb222bb3bbbb4bb3bb000bb300000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00000000000000000000000000000000000000000000000000000000
b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b3b300000000000000000000000000000000000000000000000000000000
__map__
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
